import logging
import os
import asyncio
import base64
from datetime import datetime, timedelta
from flask import Flask
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from pymongo import MongoClient
from cryptography.fernet import Fernet

logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

# Config
BOT_TOKEN = "8444279342:AAF3asBL-9YcXkMS1RX3AYngr0TN61uvVMw"
MONGO_URI = "mongodb+srv://sanomanjiro369369369_db_user:S15wDBqDsBu2zQGD@cluster0.xjz3qk.mongodb.net/content_bot?retryWrites=true&w=majority"
ADMIN_IDS = [5792484278]
PAYMENT_NUMBER = "+91 7003987024"
LINK_KEY = "SanoHub-Secret-Key-32-Chars-Long!!"

# Database
client = MongoClient(MONGO_URI)
db = client['content_bot']
users_col = db.users
movies_col = db.movies
anime_col = db.anime
modapk_col = db.modapk

# Indexes
for col in [movies_col, anime_col, modapk_col]:
    col.create_index([("title", "text"), ("keywords", "text")])

cipher = Fernet(base64.urlsafe_b64encode(LINK_KEY[:32].encode()))
app = Flask(__name__)

def get_user(user_id):
    return users_col.find_one({"user_id": user_id})

def create_user(user_id, username, first_name):
    users_col.insert_one({
        "user_id": user_id, "username": username, "first_name": first_name,
        "joined_at": datetime.now(), "is_premium": False, "premium_until": None,
        "total_downloads": 0, "referral_code": "REF{}".format(user_id)
    })

def is_premium(user_id):
    user = get_user(user_id)
    if not user or not user.get("is_premium"):
        return False
    if user.get("premium_until") and user["premium_until"] < datetime.now():
        users_col.update_one({"user_id": user_id}, {"$set": {"is_premium": False}})
        return False
    return True

def search_content(collection, query):
    return list(collection.find({
        "$or": [
            {"title": {"$regex": query, "$options": "i"}},
            {"keywords": {"$regex": query, "$options": "i"}}
        ]
    }).limit(10))

def get_content_by_id(collection, content_id):
    from bson.objectid import ObjectId
    try:
        return collection.find_one({"_id": ObjectId(content_id)})
    except:
        return None

def encrypt_link(text):
    return cipher.encrypt(text.encode()).decode()

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    if not get_user(user.id):
        create_user(user.id, user.username, user.first_name)
    
    is_prem = is_premium(user.id)
    user_data = get_user(user.id) or {}
    
    welcome_text = """ğŸ¯ <b>Welcome to SanoHub BD</b>

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‘¤ User: {}         
â”‚  ğŸ’ Status: {}     
â”‚  ğŸ“¥ Downloads: {}        
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜""".format(
        user.first_name[:15],
        'ğŸŸ¢ PREMIUM' if is_prem else 'ğŸ”´ FREE',
        user_data.get('total_downloads', 0)
    )
    
    keyboard = [
        [InlineKeyboardButton("ğŸ¬ Movies", callback_data="cat_movies"),
         InlineKeyboardButton("ğŸŒ Anime", callback_data="cat_anime")],
        [InlineKeyboardButton("ğŸ“± Mod APK", callback_data="cat_modapk")],
        [InlineKeyboardButton("ğŸ’ Premium", callback_data="menu_premium")]
    ]
    
    if user.id in ADMIN_IDS:
        keyboard.append([InlineKeyboardButton("ğŸ” Admin", callback_data="admin_panel")])
    
    await update.message.reply_text(welcome_text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode='HTML')

async def category_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data.replace("cat_", "")
    context.user_data['search_category'] = data
    
    await query.edit_message_text(
        "ğŸ” Send {} name to search:".format(data),
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("ğŸ”™ Back", callback_data="back_main")]])
    )

async def handle_search(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    query_text = update.message.text
    category = context.user_data.get('search_category', 'movies')
    
    collections = {'movies': movies_col, 'anime': anime_col, 'modapk': modapk_col}
    results = search_content(collections.get(category, movies_col), query_text)
    
    if not results:
        await update.message.reply_text("âŒ No results found!")
        return
    
    text = "ğŸ¯ Found {} results:\n\n".format(len(results))
    for idx, item in enumerate(results[:10], 1):
        text += "{}. <b>{}</b>\n   ğŸ“Š {} | ğŸ’¾ {}\n\n".format(
            idx, item.get('title', 'Unknown'), item.get('quality', 'N/A'), item.get('size', 'N/A')
        )
    
    keyboard = []
    for item in results[:10]:
        title = item.get('title', 'Unknown')[:30]
        keyboard.append([InlineKeyboardButton("ğŸ“¥ {}".format(title), 
            callback_data="dl_{}_{}".format(category, str(item['_id'])))])
    keyboard.append([InlineKeyboardButton("ğŸ”™ Back", callback_data="cat_{}".format(category))])
    
    await update.message.reply_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode='HTML')

async def download_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    data = query.data.split("_")
    if len(data) < 3:
        await query.edit_message_text("âŒ Invalid request!")
        return
    
    category, content_id = data[1], data[2]
    collections = {'movies': movies_col, 'anime': anime_col, 'modapk': modapk_col}
    content = get_content_by_id(collections.get(category), content_id)
    
    if not content:
        await query.edit_message_text("âŒ Content not found!")
        return
    
    is_prem = is_premium(update.effective_user.id)
    title = content.get('title', 'Unknown')
    quality = content.get('quality', 'N/A')
    size = content.get('size', 'N/A')
    
    if is_prem:
        link = content.get('download_link', '')
        text = "âœ¨ <b>PREMIUM</b>\n\nğŸ¬ {}\nğŸ“Š {} | ğŸ’¾ {}\n\nğŸ”— {}".format(title, quality, size, link)
        keyboard = [[InlineKeyboardButton("ğŸš€ Download", url=link)]]
    else:
        encrypted = encrypt_link("{}:{}".format(category, content_id))
        ad_link = "https://t.me/SanoHub_Bot?start=DL{}".format(encrypted[:20])
        text = "ğŸ¬ {}\nğŸ“Š {} | ğŸ’¾ {}\n\nğŸ’ Buy Premium or Watch Ad (15s)".format(title, quality, size)
        keyboard = [
            [InlineKeyboardButton("ğŸ¯ Watch Ad", url=ad_link)],
            [InlineKeyboardButton("ğŸ’ Premium", callback_data="menu_premium")]
        ]
    
    keyboard.append([InlineKeyboardButton("ğŸ”™ Back", callback_data="cat_{}".format(category))])
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode='HTML', disable_web_page_preview=True)

async def premium_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    text = """ğŸ’ <b>PREMIUM</b>

ğŸ“… 7 Days - à§³29
ğŸ“… 30 Days - à§³99  
â™¾ï¸ Lifetime - à§³499

ğŸ’³ Pay: {}
âœ… Then contact @SanoHub_Support""".format(PAYMENT_NUMBER)
    
    keyboard = [
        [InlineKeyboardButton("7 Days - à§³29", callback_data="pay_7")],
        [InlineKeyboardButton("30 Days - à§³99", callback_data="pay_30")],
        [InlineKeyboardButton("â™¾ï¸ Lifetime - à§³499", callback_data="pay_lifetime")],
        [InlineKeyboardButton("ğŸ”™ Back", callback_data="back_main")]
    ]
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode='HTML')

async def admin_panel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    if update.effective_user.id not in ADMIN_IDS:
        await query.answer("âŒ Unauthorized!", show_alert=True)
        return
    
    await query.answer()
    stats = {
        "users": users_col.count_documents({}),
        "premium": users_col.count_documents({"is_premium": True}),
        "movies": movies_col.count_documents({})
    }
    
    text = "ğŸ” <b>ADMIN</b>\n\nğŸ‘¥ Users: {}\nğŸ’ Premium: {}\nğŸ¬ Movies: {}".format(
        stats['users'], stats['premium'], stats['movies']
    )
    keyboard = [
        [InlineKeyboardButton("â• Add Content", callback_data="admin_add")],
        [InlineKeyboardButton("ğŸ“¢ Broadcast", callback_data="admin_broadcast")],
        [InlineKeyboardButton("ğŸ”™ Back", callback_data="back_main")]
    ]
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode='HTML')

async def back_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    if query.data == "back_main":
        await start(update, context)

@app.route('/')
def home():
    return "âœ… SanoHub Bot is running!"

def main():
    application = Application.builder().token(BOT_TOKEN).build()
    
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CallbackQueryHandler(category_handler, pattern="^cat_"))
    application.add_handler(CallbackQueryHandler(download_handler, pattern="^dl_"))
    application.add_handler(CallbackQueryHandler(premium_menu, pattern="^menu_premium$"))
    application.add_handler(CallbackQueryHandler(admin_panel, pattern="^admin_panel$"))
    application.add_handler(CallbackQueryHandler(back_handler, pattern="^back_"))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_search))
    
    application.run_polling()

if __name__ == "__main__":
    main()
    
